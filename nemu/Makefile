# Sanity check
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
-include $(NEMU_HOME)/include/config/auto.conf
-include $(NEMU_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))                        # param1 : "%",% diff???

# Extract variabls from menuconfig
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))              # riscv64
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))              # interpreter
NAME    = $(GUEST_ISA)-nemu-$(ENGINE)                        # riscv64-nemu-interpreter

# Include all filelist.mk to merge file lists
FILELIST_MK = $(shell find ./src -name "filelist.mk")        # lead filelist context
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)                                                # DIRS-BLACKLIST ???
SRCS-BLACKLIST-y += $(SRCS-BLACKLIST) $(shell find $(DIRS-BLACKLIST-y) -name "*.c")  # SRCS-BLACKLIST?????
SRCS-y += $(shell find $(DIRS-y) -name "*.c")                                        # src/cpu src/monitor src/utils all .c
SRCS = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))

# Extract compiler and options from menuconfig
CC = $(call remove_quote,$(CONFIG_CC))                                               # +gcc
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))                                # +-02
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)                                        # +NULL
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)                                 # +
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)                          # NULL
CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)    # $(true, true)????
CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
LDFLAGS += $(CFLAGS_BUILD)

# Include rules for menuconfig
include $(NEMU_HOME)/scripts/config.mk

ifdef CONFIG_TARGET_AM                                                               # y
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)
else
# Include rules to build NEMU
include $(NEMU_HOME)/scripts/native.mk
endif
